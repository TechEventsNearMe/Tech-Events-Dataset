name: Extract and Comment Tech Events URLs

on:
  pull_request:
    paths:
      - '**.json'

jobs:
  extract:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        run: |
          git diff --name-only origin/main HEAD --diff-filter=AM > changed_files.txt
          cat changed_files.txt

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Extract URLs
        id: extract
        run: node .github/scripts/validate-events.js
        continue-on-error: true

      - name: Comment on PR with extracted URLs
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            if (fs.existsSync('pr-comment.txt')) {
              const comment = fs.readFileSync('pr-comment.txt', 'utf8');
              
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }

      - name: Fail workflow if errors found
        if: steps.extract.outcome == 'failure'
        run: exit 1